<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LDFIT â€“ ×ª×›× ×•×Ÿ ×ª×–×•× ×” ×•××™××•× ×™× (××¡×£)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0b0e11;--card:#141a21;--muted:#aab2bd;--text:#e6edf3;--accent:#4aa3ff;--ok:#3fb950;--warn:#f2cc60;--bad:#f85149}
    *{box-sizing:border-box}
    body{margin:0;font-family:"Rubik",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;background:rgba(11,14,17,.9);backdrop-filter: blur(6px);border-bottom:1px solid #1f2630;z-index:10}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{margin:8px 0 0;font-size:20px}
    nav{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
    nav button{background:#1a212b;color:var(--text);border:1px solid #263141;padding:8px 12px;border-radius:10px;cursor:pointer}
    nav button.active{border-color:var(--accent);box-shadow:0 0 0 2px rgba(74,163,255,.2)}
    .card{background:var(--card);border:1px solid #223042;border-radius:14px;padding:14px;margin:14px 0}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:10px 8px;border-bottom:1px dashed #2a394a;vertical-align:top}
    th{color:var(--muted);font-weight:500;text-align:right}
    td[contenteditable="true"]{outline:none}
    td[contenteditable="true"]:focus{box-shadow:inset 0 0 0 2px var(--accent);border-radius:6px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row > .col{flex:1 1 320px}
    .muted{color:var(--muted)}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#1e2936;border:1px solid #2a394a;color:#bcd}
    .btn{background:#1b2734;border:1px solid #2d3a4a;color:#e6edf3;padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn.primary{border-color:var(--accent)}
    .btn.good{border-color:var(--ok)}
    .btn.warn{border-color:var(--warn)}
    .btn.bad{border-color:var(--bad)}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
    input,select,textarea{width:100%;background:#0f141a;border:1px solid #283243;color:var(--text);padding:8px 10px;border-radius:8px}
    small{color:#8fa3b8}
    footer{padding:24px 0;color:#8fa3b8}
    .hint{font-size:12px;color:#91a4b7}
    .section-title{display:flex;align-items:center;justify-content:space-between;gap:12px}
  </style>

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b0e11">
</head>
<body>
<header>
  <div class="wrap">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
      <div>
        <h1>ğŸ‘Ÿ LDFIT â€“ ×ª×›× ×•×Ÿ ×©×‘×•×¢×™ (××¡×£)</h1>
        <div class="muted">××™× â†’ ×—×œ×‘×•×Ÿ â†’ ×™×¨×§×•×ª â†’ ×¤×—××™××” Â· ×©×§×™×œ×” ×¤×¢× ×‘×©×‘×•×¢ Â· × ×©× ×•×© ×¢×“ 100 ×§×œ×³</div>
      </div>
      <div class="row" style="align-items:center">
        <button class="btn" id="btnExportJSON">×™×¦×•× JSON</button>
        <label class="btn" for="fileImport" style="cursor:pointer">×™×‘×•× JSON<input id="fileImport" type="file" accept=".json" style="display:none"></label>
      </div>
    </div>
    <nav>
      <button data-tab="plan" class="active">×œ×•×— ××•×›×œ</button>
      <button data-tab="groceries">×¨×©×™××ª ×§× ×™×•×ª</button>
      <button data-tab="tracker">×˜×‘×œ×ª ××¢×§×‘</button>
      <button data-tab="settings">×”×’×“×¨×•×ª & ×¡×™× ×›×¨×•×Ÿ</button>
    </nav>
  </div>
</header>

<main class="wrap">
  <!-- PLAN -->
  <section class="card" id="tab-plan">
    <div class="section-title">
      <h2>×œ×•×— ××•×›×œ ×©×‘×•×¢×™</h2>
      <div class="row">
        <button class="btn" id="btnNewWeek">×”×ª×—×œ ×©×‘×•×¢ ×—×“×©</button>
        <span class="pill" id="weekRangePill"></span>
      </div>
    </div>
    <div class="hint">×¢×¨×™×›×” ×™×©×™×¨×” ×‘×ª××™× â€“ × ×©××¨ ××•×˜×•××˜×™×ª</div>
    <div id="planTable"></div>
  </section>

  <!-- GROCERIES -->
  <section class="card" id="tab-groceries" hidden>
    <div class="section-title">
      <h2>×¨×©×™××ª ×§× ×™×•×ª (× ×’×–×¨×ª ××”×œ×•×—)</h2>
      <button class="btn" id="btnCopyGroceries">×”×¢×ª×§</button>
    </div>
    <div id="groceriesTable"></div>
    <small>×›××•×™×•×ª ×”×Ÿ ×œ××—×¨ ×‘×™×©×•×œ; ×œ×§× ×™×™×” ×©×œ ×—×•××¨×™ ×’×œ× ×§×— ~Ã—1.2.</small>
  </section>

  <!-- TRACKER -->
  <section class="card" id="tab-tracker" hidden>
    <div class="section-title">
      <h2>×˜×‘×œ×ª ××¢×§×‘</h2>
      <div class="row"><button class="btn good" id="btnWater1">+250 ××´×œ</button><button class="btn good" id="btnWater2">+500 ××´×œ</button></div>
    </div>
    <div id="trackerTable"></div>
    <small>×™×¢×“ ×©×ª×™×™×” ×™×•××™: 3000 ××´×œ Â· ×©×§×™×œ×” ××•××œ×¦×ª ×¤×¢× ×‘×©×‘×•×¢ (×’×³â€“×“×³)</small>
  </section>

  <!-- SETTINGS -->
  <section class="card" id="tab-settings" hidden>
    <h2>×”×’×“×¨×•×ª ×•×¡×™× ×›×¨×•×Ÿ</h2>
    <div class="grid">
      <div>
        <label>×ª××¨×™×š ×ª×—×™×œ×ª ×©×‘×•×¢ (×¨××©×•×Ÿ)</label>
        <input id="weekStart" type="date">
        <small>××©××© ×œ×—×™×©×•×‘ ×”×ª××¨×™×›×™× ×‘×©×‘×•×¢</small>
      </div>
      <div>
        <label>××¦×‘ ×¡×™× ×›×¨×•×Ÿ</label>
        <select id="syncMode">
          <option value="local">××§×•××™ (LocalStorage)</option>
          <option value="gist">GitHub Gist (×œ×¡×™× ×›×¨×•×Ÿ ×¢× ×Ÿ)</option>
        </select>
      </div>
      <div id="gistSettings" hidden>
        <label>GitHub Token (scope: gist)</label>
        <input id="gistToken" type="password" placeholder="ghp_...">
        <label>ID ×©×œ Gist ×œ×§×•×‘×¥ ×”×¡×™× ×›×¨×•×Ÿ</label>
        <input id="gistId" placeholder="×œ×“×•×’××”: a1b2c3d4e5f6...">
        <label>×©× ×§×•×‘×¥ ×‘×ª×•×š ×”-Gist</label>
        <input id="gistFilename" placeholder="ldfit-asaf.json" value="ldfit-asaf.json">
        <div class="row">
          <button class="btn primary" id="btnGistPull">×˜×¢×Ÿ ××”-Gist</button>
          <button class="btn primary" id="btnGistPush">×©××•×¨ ×œ-Gist</button>
        </div>
        <small>×”×˜×•×§×Ÿ ×œ× × ×©××¨ ×‘×¢× ×Ÿ â€“ ×¨×§ ×‘×“×¤×“×¤×Ÿ ×”××§×•××™. ×”×›× ×¡ ××•×ª×• ×‘×›×œ ××›×©×™×¨ ×©×‘×• ×ª×¨×¦×” ×œ×”×¡×ª× ×›×¨×Ÿ.</small>
      </div>
    </div>
  </section>
</main>

<footer class="wrap">
  <div>× ×‘× ×” ×§×œ×™×œ ×•× ×§×™ â€“ ×•× ×©××¨ ××•×˜×•××˜×™×ª. ×× ×ª×¨×¦×”, ×¤×¨×¡× ××ª ×”×ª×™×§×™×™×” ×”×–×• ×‘-GitHub Pages / Netlify.</div>
</footer>

<script>
const HE_DAYS = ["×¨××©×•×Ÿ","×©× ×™","×©×œ×™×©×™","×¨×‘×™×¢×™","×—××™×©×™","×©×™×©×™","×©×‘×ª"];
const STORAGE_KEY = "ldfit_asaf_state_v1";

// ---------- Default dataset (×¢× ×”×—×œ×¤×ª ×—×–×” ×”×•×“×• -> ×¤×¨×’×™×ª) ----------
function sundayOf(date){
  const d = new Date(date);
  const day = d.getDay(); // 0=Sunday in some locales? In JS 0=Sunday
  const diff = (day + 6) % 7; // distance from Sunday when Sunday=0 => diff=0
  d.setDate(d.getDate() - diff);
  d.setHours(0,0,0,0);
  return d;
}
const WEEK_START = sundayOf(new Date());

const defaultState = {
  weekStart: WEEK_START.toISOString().slice(0,10),
  plan: HE_DAYS.map((name, i) => {
    const dt = new Date(WEEK_START); dt.setDate(dt.getDate()+i);
    const dateStr = dt.toISOString().slice(0,10);
    const rows = [
      // [meal, protein, carb, veg, note]
    ];
    const template = [
      // Lunch
      ["×¦×”×¨×™×™×","", "", "×¡×œ×˜/×™×¨×§×•×ª ×—×•×¤×©×™", ""],
      // Dinner
      ["×¢×¨×‘","", "", "×¡×œ×˜/×™×¨×§×•×ª/×™×¨×§×•×ª ××¤×•×™×™×", ""],
      // Snack
      ["× ×©× ×•×©","", "", "", "â‰¤100 ×§×œ×³"]
    ];
    // Pre-fill by day
    const byDay = [
      // ×¨××©×•×Ÿ
      [["×¦×”×¨×™×™×","×—×–×” ×¢×•×£ 250×’×¨×³","××•×¨×– ×œ×‘×Ÿ 100×’×¨×³","×¡×œ×˜ ×—×•×¤×©×™","×›×•×¡ ××™× ×œ×¤× ×™"],["×¢×¨×‘","×¡×œ××•×Ÿ 200×’×¨×³","×§×™× ×•××” 100×’×¨×³","×™×¨×§×•×ª",""],["× ×©× ×•×©","","","", "×™×•×’×•×¨×˜ ×“×œ"]],
      // ×©× ×™ (×”×™×” ×—×–×” ×”×•×“×• -> ××—×œ×™×£ ×œ×¤×¨×’×™×ª)
      [["×¦×”×¨×™×™×","×¤×¨×’×™×ª 250×’×¨×³","×¤×¡×˜×” 100×’×¨×³","×™×¨×§×•×ª ××¤×•×™×™×","××™××•×Ÿ ×›×•×—"],["×¢×¨×‘","×—×–×” ×¢×•×£ 200×’×¨×³","×‘×˜×˜×” 150×’×¨×³","×™×¨×§×•×ª",""],["× ×©× ×•×©","","","", "×©×•×§×•×œ×“ ××¨×™×¨ 1â€“2 ×§×•×‘×™×•×ª"]],
      // ×©×œ×™×©×™
      [["×¦×”×¨×™×™×","×‘×§×¨ ×¨×–×” 250×’×¨×³","×‘×•×¨×’×•×œ 100×’×¨×³","×¡×œ×˜ ×—×•×¤×©×™","××™×¨×•×‘×™ ×§×œ"],["×¢×¨×‘","×“×’ ×œ×‘×Ÿ 200×’×¨×³","××•×¨×– 100×’×¨×³","×™×¨×§×•×ª",""],["× ×©× ×•×©","","","", "×¤×¨×™×›×™×•×ª 2â€“3"]],
      // ×¨×‘×™×¢×™
      [["×¦×”×¨×™×™×","×—×–×” ×¢×•×£ 250×’×¨×³","×¤×™×ª×” ×›×•×¡××™×Ÿ 1/2","×™×¨×§×•×ª ××¤×•×™×™×",""],["×¢×¨×‘","×‘×§×¨ ×¨×–×” 200×’×¨×³","×ª×¤×•×— ××“××” 150×’×¨×³","×™×¨×§×•×ª","××•×¤×¦×™×•× ×œ×™: ×¦×³×™×˜ ××—×¨×™ ×›×•×—"],["× ×©× ×•×©","","","", "××¢×“×Ÿ ×—×œ×‘×•×Ÿ"]],
      // ×—××™×©×™ (×”×™×” ×—×–×” ×”×•×“×• -> ××—×œ×™×£ ×œ×¤×¨×’×™×ª)
      [["×¦×”×¨×™×™×","×¤×¨×’×™×ª 250×’×¨×³","×§×•×¡×§×•×¡ 100×’×¨×³","×¡×œ×˜ ×—×•×¤×©×™","××™××•×Ÿ ×›×•×—"],["×¢×¨×‘","×—×–×” ×¢×•×£ 200×’×¨×³","×§×™× ×•××” 100×’×¨×³","×™×¨×§×•×ª",""],["× ×©× ×•×©","","","", "×§×¨×§×¨×™× ×“×œ×™ ×§×œ×•×¨×™×•×ª"]],
      // ×©×™×©×™
      [["×¦×”×¨×™×™×","×¤×¨×’×™×ª 250×’×¨×³","××•×¨×– 100×’×¨×³","×¡×œ×˜ ×—×•×¤×©×™",""],["×¢×¨×‘","×“×’ ×œ×‘×Ÿ 200×’×¨×³","×‘×˜×˜×” 150×’×¨×³","×™×¨×§×•×ª","× ×•×”×œ ×¡×•×¤×´×©"],["× ×©× ×•×©","","","", "×™×•×’×•×¨×˜ ×“×œ"]],
      // ×©×‘×ª
      [["×¦×”×¨×™×™×","×§×¦×™×¦×•×ª ×¢×•×£/×‘×§×¨ 250×’×¨×³","×¤×¡×˜×” 100×’×¨×³","×¡×œ×˜ ×—×•×¤×©×™",""],["×¢×¨×‘","×—×–×” ×¢×•×£/×“×’ 200×’×¨×³","×§×•×¡×§×•×¡ 100×’×¨×³","×™×¨×§×•×ª",""],["× ×©× ×•×©","","","", "×¤×¨×™/×¤×¨×™×›×™×•×ª"]],
    ];
    const chosen = byDay[i];
    return {day:name, date:dateStr, rows: chosen || template};
  }),
  tracker: HE_DAYS.map((name,i)=>{
    const dt = new Date(WEEK_START); dt.setDate(dt.getDate()+i);
    return {day:name,date:dt.toISOString().slice(0,10), water:0, protein:"", carbs:"", workout:"", steps:"", sleep:"", weight:""};
  }),
  sync: {mode:"local", gist:{token:"", id:"", filename:"ldfit-asaf.json"}}
};

// ---------- Persistence ----------
function saveState(state){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}
function loadState(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw){ saveState(defaultState); return defaultState; }
  try { return JSON.parse(raw); } catch(e){ console.error(e); saveState(defaultState); return defaultState; }
}
let state = loadState();

// ---------- UI helpers ----------
function $(sel, root=document){ return root.querySelector(sel) }
function $all(sel, root=document){ return Array.from(root.querySelectorAll(sel)) }

function renderWeekRange(){
  const s = new Date(state.weekStart);
  const e = new Date(s); e.setDate(e.getDate()+6);
  $("#weekRangePill").textContent = `${s.toLocaleDateString('he-IL')} â†’ ${e.toLocaleDateString('he-IL')}`;
}

// ---------- PLAN ----------
function renderPlan(){
  const container = $("#planTable");
  const tbl = document.createElement("table");
  const thead = document.createElement("thead");
  thead.innerHTML = `<tr>
    <th>×™×•×</th><th>×ª××¨×™×š</th><th>××¨×•×—×”</th><th>×—×œ×‘×•×Ÿ</th><th>×¤×—××™××”</th><th>×™×¨×§</th><th>×”×¢×¨×•×ª</th>
  </tr>`;
  tbl.appendChild(thead);
  const tbody = document.createElement("tbody");
  state.plan.forEach((d,di)=>{
    d.rows.forEach((r,ri)=>{
      const tr = document.createElement("tr");
      if(ri===0){
        tr.innerHTML = `<td rowspan="3"><b>${d.day}</b></td><td rowspan="3">${d.date}</td>`;
      }
      const meal = ri===0? "×¦×”×¨×™×™×" : ri===1? "×¢×¨×‘" : "× ×©× ×•×©";
      const cells = [
        meal, r[1]||"", r[2]||"", r[3]||"", r[4]||""
      ];
      cells.forEach((val, ci)=>{
        const td = document.createElement("td");
        td.textContent = val;
        if(ci>0){ // editable all but meal name
          td.contentEditable = "true";
          td.addEventListener("blur", ()=>{
            const idx = ci; // 1..4 -> maps to r[1]..r[4]
            r[idx] = td.textContent.trim();
            saveState(state);
            // re-render groceries because ingredients may change
            renderGroceries();
          });
        }
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  });
  tbl.appendChild(tbody);
  container.innerHTML = "";
  container.appendChild(tbl);
}

// ---------- GROCERIES (aggregate) ----------
function parseQty(text){
  // Try to extract number and unit from common patterns: "250×’×¨×³", "100×’×¨×³", "1/2", "150×’×¨×³", "1 ×™×—×³"
  if(!text) return null;
  const t = text.replace(/\s+/g,'').replace(/×³/g,"");
  // 1/2 â†’ 0.5
  if(/^\d+\/\d+$/.test(t)) return {qty: eval(t), unit:"×™×—×³"};
  // number + ×’×¨×
  let m = t.match(/^(\d+(?:\.\d+)?)×’×¨.?$/);
  if(m) return {qty: parseFloat(m[1]), unit:"×’×¨× (××—×¨×™ ×‘×™×©×•×œ)"};
  // number + ×™×—×³
  m = t.match(/^(\d+(?:\.\d+)?)×™×—.?$/);
  if(m) return {qty: parseFloat(m[1]), unit:"×™×—×³"};
  return null;
}
function addItem(map, name, qty, unit){
  if(!name || !qty) return;
  const key = name.trim();
  if(!map[key]) map[key] = {qty:0, unit};
  map[key].qty += qty;
}
function normalizeProteinName(s){
  if(!s) return null;
  s = s.replace(/\s+/g,' ').trim();
  // collapse families
  if(/×—×–×” ×¢×•×£|×©× ×™×¦×œ ×¢×•×£/.test(s)) return "×—×–×” ×¢×•×£";
  if(/×¤×¨×’×™×ª/.test(s)) return "×¤×¨×’×™×ª";
  if(/×”×•×“×•/.test(s)) return "×—×–×” ×”×•×“×•";
  if(/×‘×§×¨|×¡×™× ×˜×”|×©×™×™×˜×œ|×× ×˜×¨×™×§×•×˜/.test(s)) return "×‘×§×¨ ×¨×–×”";
  if(/×¡×œ××•×Ÿ/.test(s)) return "×¡×œ××•×Ÿ";
  if(/×“×’ ×œ×‘×Ÿ|××× ×•×Ÿ|×“× ×™×¡|×œ×‘×¨×§|× ×¡×™×›×ª/.test(s)) return "×“×’ ×œ×‘×Ÿ";
  if(/×§×¦×™×¦×•×ª/.test(s)) return "×§×¦×™×¦×•×ª ×¢×•×£/×‘×§×¨";
  return s;
}
function normalizeCarbName(s){
  if(!s) return null;
  s = s.replace(/\s+/g,' ').trim();
  if(/××•×¨×–/.test(s)) return "××•×¨×– ××‘×•×©×œ";
  if(/×¤×¡×˜×”/.test(s)) return "×¤×¡×˜×” ××‘×•×©×œ×ª";
  if(/×§×™× ×•××”/.test(s)) return "×§×™× ×•××” ××‘×•×©×œ×ª";
  if(/×§×•×¡×§×•×¡/.test(s)) return "×§×•×¡×§×•×¡ ××•×›×Ÿ";
  if(/×‘×•×¨×’×•×œ/.test(s)) return "×‘×•×¨×’×•×œ ××‘×•×©×œ";
  if(/×‘×˜×˜×”/.test(s)) return "×‘×˜×˜×” ××¤×•×™×”";
  if(/×ª×¤×•×—.?××“××”/.test(s)) return "×ª×¤×•×— ××“××” ××¤×•×™";
  if(/×¤×™×ª×”/.test(s)) return "×¤×™×ª×” ×›×•×¡××™×Ÿ";
  return s;
}
function aggregateGroceries(){
  const map = {};
  state.plan.forEach(d=>{
    d.rows.forEach(r=>{
      // protein r[1], carb r[2]
      const p = r[1].match(/^[^0-9]+/); // name is non-digits prefix
      if(p){
        const name = normalizeProteinName(p[0].trim());
        const qty = parseQty(r[1].replace(name,"").trim());
        if(name && qty) addItem(map, name, qty.qty, qty.unit || "×’×¨× (××—×¨×™ ×‘×™×©×•×œ)");
      }
      const c = r[2].match(/^[^0-9]+|^1\/2|^\d+\s?×™×—/);
      if(c){
        const carbName = normalizeCarbName(r[2].split(/\d/)[0].trim() || r[2]);
        const qty = parseQty(r[2].replace(carbName,"").trim());
        if(carbName && qty) addItem(map, carbName, qty.qty, qty.unit || "×’×¨× (××—×¨×™ ×‘×™×©×•×œ)");
      }
      // snacks
      const note = r[4]||"";
      if(/×™×•×’×•×¨×˜|××¢×“×Ÿ/.test(note)) addItem(map, "×™×•×’×•×¨×˜/××¢×“×Ÿ ×—×œ×‘×•×Ÿ (×“×œ)", 1, "×™×—×³");
      if(/×¤×¨×™×›×™×•×ª/.test(note)) addItem(map, "×¤×¨×™×›×™×•×ª ××•×¨×–/×ª×™×¨×¡", 1, "×—×‘×³");
      if(/×§×¨×§×¨/.test(note)) addItem(map, "×§×¨×§×¨×™× ×“×œ×™ ×§×œ×•×¨×™×•×ª", 1, "×—×‘×³");
      if(/×©×•×§×•×œ×“/.test(note)) addItem(map, "×©×•×§×•×œ×“ ××¨×™×¨", 0.2, "×—×‘×³");
      if(/×¤×¨×™/.test(note)) addItem(map, "×¤×™×¨×•×ª", 2, "×™×—×³");
    });
  });
  // Veg base
  addItem(map,"×™×¨×§×•×ª ×œ×¡×œ×˜ (××œ×¤×¤×•×Ÿ/×¢×’×‘× ×™×”/×¤×œ×¤×œ)", 10, "×™×—×³ ××¢×•×¨×‘");
  addItem(map,"×¢×œ×™ ×—×¡×”/×‘×™×™×‘×™", 2, "×—×‘×³");
  addItem(map,"×™×¨×§×•×ª ×œ×ª× ×•×¨ (×§×™×©×•×/×’×–×¨/×‘×¦×œ)", 3, "×§\"×’");
  addItem(map,"×ª×‘×œ×™× ×™×/×¡×¤×¨×™×™ ×©××Ÿ", 1, "×¡×˜× ×“×¨×˜×™");
  // 1.2x raw-material hint is in UI only.
  return map;
}
function renderGroceries(){
  const map = aggregateGroceries();
  const entries = Object.entries(map).sort((a,b)=>a[0].localeCompare(b[0],'he'));
  const container = $("#groceriesTable");
  const tbl = document.createElement("table");
  tbl.innerHTML = `<thead><tr><th>××•×¦×¨</th><th>×›××•×ª ×œ×©×‘×•×¢</th><th>×™×—×™×“×”</th></tr></thead>`;
  const tbody = document.createElement("tbody");
  entries.forEach(([name, obj])=>{
    const tr = document.createElement("tr");
    const qty = Math.round((obj.qty + Number.EPSILON) * 100) / 100;
    tr.innerHTML = `<td>${name}</td><td>${qty}</td><td>${obj.unit||""}</td>`;
    tbody.appendChild(tr);
  });
  tbl.appendChild(tbody);
  container.innerHTML = "";
  container.appendChild(tbl);
}

// ---------- TRACKER ----------
function renderTracker(){
  const container = $("#trackerTable");
  const tbl = document.createElement("table");
  tbl.innerHTML = `<thead><tr>
    <th>×™×•×</th><th>×ª××¨×™×š</th>
    <th>×©×ª×™×™×” (××´×œ, ×™×¢×“ 3000)</th><th>×”×’×¢×ª×™ ×œ×—×œ×‘×•×Ÿ?</th>
    <th>×¤×—××™××” ×œ×¤×™ ×ª×¤×¨×™×˜?</th><th>××™××•×Ÿ</th><th>×¦×¢×“×™×</th><th>×©×¢×•×ª ×©×™× ×”</th><th>××©×§×œ</th>
  </tr></thead>`;
  const tbody = document.createElement("tbody");
  state.tracker.forEach((t, i)=>{
    const tr = document.createElement("tr");
    const cols = ["day","date","water","protein","carbs","workout","steps","sleep","weight"];
    cols.forEach((key,ci)=>{
      const td = document.createElement("td");
      td.textContent = t[key] ?? "";
      if(ci>=2){ // editable, except day/date
        td.contentEditable = "true";
        td.addEventListener("blur", ()=>{
          state.tracker[i][key] = td.textContent.trim();
          saveState(state);
        });
      }
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  tbl.appendChild(tbody);
  container.innerHTML = "";
  container.appendChild(tbl);
}
function addWater(amount){
  // add to today's row
  const today = new Date().toISOString().slice(0,10);
  const row = state.tracker.find(r=>r.date===today);
  if(row){
    const cur = parseInt(row.water||"0",10)||0;
    row.water = String(cur + amount);
    saveState(state); renderTracker();
  }
}

// ---------- Tabs ----------
$all("nav button").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    $all("nav button").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    const tab = btn.dataset.tab;
    $("#tab-plan").hidden = tab!=="plan";
    $("#tab-groceries").hidden = tab!=="groceries";
    $("#tab-tracker").hidden = tab!=="tracker";
    $("#tab-settings").hidden = tab!=="settings";
  });
});
$("#btnWater1").addEventListener("click", ()=>addWater(250));
$("#btnWater2").addEventListener("click", ()=>addWater(500));

// ---------- Settings ----------
function renderSettings(){
  $("#weekStart").value = state.weekStart;
  $("#syncMode").value = state.sync.mode || "local";
  const gs = state.sync.gist||{token:"",id:"",filename:"ldfit-asaf.json"};
  $("#gistSettings").hidden = state.sync.mode!=="gist";
  $("#gistToken").value = gs.token||"";
  $("#gistId").value = gs.id||"";
  $("#gistFilename").value = gs.filename||"ldfit-asaf.json";
}
$("#weekStart").addEventListener("change", e=>{
  state.weekStart = e.target.value;
  // shift dates
  const s = new Date(state.weekStart);
  state.plan.forEach((d,i)=>{ const dt = new Date(s); dt.setDate(dt.getDate()+i); d.date = dt.toISOString().slice(0,10) });
  state.tracker.forEach((t,i)=>{ const dt = new Date(s); dt.setDate(dt.getDate()+i); t.date = dt.toISOString().slice(0,10) });
  saveState(state); renderWeekRange(); renderPlan(); renderTracker();
});
$("#syncMode").addEventListener("change", e=>{
  state.sync.mode = e.target.value;
  $("#gistSettings").hidden = state.sync.mode!=="gist";
  saveState(state);
});
["gistToken","gistId","gistFilename"].forEach(id=>{
  $("#"+id).addEventListener("change", e=>{
    state.sync.gist = state.sync.gist || {};
    state.sync.gist[id.replace("gist","").toLowerCase()] = e.target.value.trim();
    // map: token,id,filename
    state.sync.gist.token = $("#gistToken").value.trim();
    state.sync.gist.id = $("#gistId").value.trim();
    state.sync.gist.filename = $("#gistFilename").value.trim();
    saveState(state);
  });
});

// ---------- New week ----------
$("#btnNewWeek").addEventListener("click", ()=>{
  if(!confirm("×œ×¤×ª×•×— ×©×‘×•×¢ ×—×“×© (×™×©××•×¨ ××ª ×”× ×ª×•× ×™× ×”×§×™×™××™× ×œ×©×—×–×•×¨ ×“×¨×š JSON)?")) return;
  const s = sundayOf(new Date());
  const fresh = JSON.parse(JSON.stringify(defaultState));
  fresh.weekStart = s.toISOString().slice(0,10);
  state.plan = fresh.plan;
  state.tracker = fresh.tracker;
  state.weekStart = fresh.weekStart;
  saveState(state);
  renderWeekRange(); renderPlan(); renderGroceries(); renderTracker(); renderSettings();
});

// ---------- Copy groceries ----------
$("#btnCopyGroceries").addEventListener("click", ()=>{
  const map = aggregateGroceries();
  const lines = Object.entries(map).sort((a,b)=>a[0].localeCompare(b[0],'he')).map(([k,v])=>`â€¢ ${k}: ${Math.round(v.qty*100)/100} ${v.unit||""}`);
  navigator.clipboard.writeText(lines.join("\n")).then(()=>{
    alert("×”×¨×©×™××” ×”×•×¢×ª×§×” ×œ×œ×•×—");
  });
});

// ---------- Import/Export JSON ----------
$("#btnExportJSON").addEventListener("click", ()=>{
  const blob = new Blob([JSON.stringify(state,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "ldfit-asaf.json";
  a.click();
});
$("#fileImport").addEventListener("change", async (e)=>{
  const file = e.target.files[0];
  if(!file) return;
  const text = await file.text();
  try{
    const obj = JSON.parse(text);
    state = obj; saveState(state);
    renderWeekRange(); renderPlan(); renderGroceries(); renderTracker(); renderSettings();
    alert("× ×˜×¢×Ÿ ×‘×”×¦×œ×—×”");
  }catch(err){ alert("×§×•×‘×¥ ×œ× ×ª×§×™×Ÿ"); }
});

// ---------- Gist Sync ----------
async function gistFetch(method, path, body, token){
  const res = await fetch(`https://api.github.com${path}`, {
    method,
    headers:{
      "Accept":"application/vnd.github+json",
      "Authorization": `Bearer ${token}`
    },
    body: body ? JSON.stringify(body) : undefined
  });
  if(!res.ok){
    const t = await res.text();
    throw new Error(`GitHub API ${res.status}: ${t}`);
  }
  return res.json();
}
$("#btnGistPull").addEventListener("click", async ()=>{
  try{
    const {token,id,filename} = state.sync.gist;
    if(!token||!id||!filename) throw new Error("×—×¡×¨ token/id/filename");
    const data = await gistFetch("GET", `/gists/${id}`, null, token);
    const file = data.files[filename];
    if(!file) throw new Error("×”×§×•×‘×¥ ×œ× × ××¦× ×‘×ª×•×š ×”-Gist");
    const content = file.content;
    const obj = JSON.parse(content);
    state = obj; saveState(state);
    renderWeekRange(); renderPlan(); renderGroceries(); renderTracker(); renderSettings();
    alert("× ×˜×¢×Ÿ ××”-Gist");
  }catch(e){ alert("×©×’×™××”: " + e.message); }
});
$("#btnGistPush").addEventListener("click", async ()=>{
  try{
    const {token,id,filename} = state.sync.gist;
    if(!token||!id||!filename) throw new Error("×—×¡×¨ token/id/filename");
    const body = { files: {} };
    body.files[filename] = { content: JSON.stringify(state,null,2) };
    await gistFetch("PATCH", `/gists/${id}`, body, token);
    alert("× ×©××¨ ×œ-Gist");
  }catch(e){ alert("×©×’×™××”: " + e.message); }
});

// ---------- Initial render ----------
renderWeekRange();
renderPlan();
renderGroceries();
renderTracker();
renderSettings();
</script>

<script>
// Register Service Worker for offline + PWA
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('./service-worker.js').catch(console.error);
  });
}
</script>
</body>
</html>
